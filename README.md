# Контейнеризированный модуль для генерации отчетов в формате xlsx

## Функционал

Модуль в реальном времени отслеживает таблицу "report" в привязанной 
БД (PostgreSQL) на наличие запросов, готовых к обработке. 
Готовность запроса к обработке определяется определенным статусом 
запроса отслеживаемый через поле "status_id".

Входные данные для формирования отчета запрашиваются из API-отчетов 
Яндекс.AppМетрики, параметры необходимые для выполнения http-запроса
подтягиваются из соответствующих полей объекта report.

Результатом работы модуля является 
[xlsx-файл](example/Отчёт_по_приложению_Узнай_москву_09-10-2025-24-11-2025_1769411544.xlsx)
который загружается в S3-хранилище по пути, определенному в
переменной S3_PATH модуля main.py

Для работы программы требуется: 
- наличие базы данных со структурой, 
определенной в [database/models.py](database/models.py)
Строка подключения к БД определяется в файле [database/db.py](database/db.py).
Для работы с БД используется библиотека SQLAlchemy.
- развернутое S3-хранилище (MinIo)

# Структура проекта:

- main.py - точка входа в программу
- settings.py - модуль для загрузки параметров конфигурации из переменных 
окружения
- database - пакет из двух модулей, в котором происходит параметров
подключения к БД и моделей (структуры) таблиц
- get_utm_tag - пакет для загрузки специфичных utm-тегов, в соответствии 
с которыми формируются параметры запроса к API отчетов Яндекс.AppМетрики
  (написан сторонним разработчиком)
- integrations - пакет с модулем, с помощью которого запрашиваются данные
из API отчетов Яндекс.AppМетрики
- utils - пакет с вспомогательными модулями для формирования xlsx-файла
и работы с S3-хранилищем
- params_config.json - конфиг с параметрами запроса данных из 
API отчетов Яндекс.AppМетрики

# Необходимые компоненты 
- Python 3.11^
- PostgreSQL 17.4
- Виртуальное окружение
- файл окружения с наименованием .env

# Требования к переменным окружения
Переменные окружения подгружаются из файла .env с помощью библиотеки dotenv.
В файле окружения должны находиться следующие переменные:
- переменные внешних интеграции:
  - YAPP_TOKEN - токен API отчетов Яндекс.AppМетрики
  - YANDEX_DIRECT_TOKEN - токен API Яндекс.Директ
- переменные базы данных:
  - DB_NAME - имя БД
  - DB_USER - имя пользователя БД
  - DB_PASSWORD - пароль
  - DB_HOST - адрес сервера БД
  - DB_PORT - порт БД
- переменные S3-хранилища (MinIo)
  - S3_ENDPOINT_URL - основной адрес хранилища 
  - S3_OUTER_ENDPOINT_URL - внешний адрес хранилища 
  - S3_ACCESS_KEY - логин от хранилища
  - S3_SECRET_KEY - пароль от хранилища
  - S3_BUCKET_NAME - имя корзины с которой будет работать API 
  - S3_SECURE - параметр безопасности
- переменные (по-умолчанию) модуля get_utm_tag/test_part2.py
  - MAIN_SCANNING_SLEEP=3
  - PROCESSES_WATCHER_SLEEP=60
  - LIMIT_NUMBER_THREADS=20
  - TIME_BUFFER_FOR_STUCK_PROCESSES_MINUTES=5

# Создание виртуального окружения
windows power shell:
- Создание: ```python -m venv <имя_окружения>```
- Запуск: ```<имя_окружения>/Scripts/activate```

# Установка необходимых библиотек
Необходиые библиотеки представлены в файле requirements.txt. 
Для установки требуется выполнить команду: 

(winwows power shell): ```pip install -r requirements.txt```

# Локальный запуск

Для локальной работы достаточно запустить модуль main.py: ```python main.py```

# Docker
Запуск в docker-контейнере

Сборка образа: ```docker build -t <имя_образа>```

Базовый запуск контейнера: ```docker run <имя_образа>```